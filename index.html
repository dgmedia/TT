<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pebble Studio</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #09090b;
            --bg-elevated: #18181b;
            --bg-hover: #27272a;
            --border: #27272a;
            --text: #fafafa;
            --text-muted: #71717a;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --success: #22c55e;
            --error: #ef4444;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .app {
            display: grid;
            grid-template-columns: 220px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.75rem;
        }
        
        .logo-icon {
            width: 34px;
            height: 34px;
            background: var(--accent);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text { font-weight: 600; font-size: 1rem; }
        
        .nav { flex: 1; }
        .nav-section { margin-bottom: 1.25rem; }
        
        .nav-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            padding-left: 0.6rem;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.6rem;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.85rem;
            color: var(--text-muted);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: var(--bg-elevated); color: var(--text); }
        
        /* Main */
        .main {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header-actions { display: flex; gap: 0.5rem; }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { color: var(--text); }
        .btn-small { padding: 0.35rem 0.7rem; font-size: 0.75rem; }
        
        /* Cards */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .card-title { font-weight: 500; font-size: 0.9rem; }
        
        /* Media Section */
        .media-section-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .media-preview {
            width: 80px;
            height: 50px;
            background: var(--bg-hover);
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .media-preview img, .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-info { flex: 1; }
        .media-label { font-weight: 500; font-size: 0.85rem; }
        .media-type { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        
        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.open { display: flex; }
        
        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title { font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        
        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Search */
        .search-box { margin-bottom: 1rem; }
        .search-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .search-input:focus { outline: none; border-color: var(--accent); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }
        
        .upload-zone:hover { border-color: var(--accent); background: rgba(249, 115, 22, 0.05); }
        .upload-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .upload-text { font-size: 0.85rem; color: var(--text-muted); }
        
        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-item {
            aspect-ratio: 16/9;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        
        .result-item img, .result-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .result-item:hover::after {
            content: 'Select';
            position: absolute;
            inset: 0;
            background: rgba(249, 115, 22, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s;
            z-index: 2000;
        }
        
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        
        /* Colors */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        
        .color-label { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem; }
        .form-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
        }
        
        .form-input:focus { outline: none; border-color: var(--accent); }
        
        textarea.form-input { min-height: 80px; resize: vertical; }
        
        /* Accordion */
        .accordion-item { margin-bottom: 0.5rem; }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .accordion-header:hover { background: var(--bg-hover); }
        .accordion-title { font-weight: 500; font-size: 0.9rem; }
        .accordion-icon { transition: transform 0.2s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 0.75rem; }
        .accordion-item.open .accordion-content { display: block; }
        
        /* Loading */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .hidden { display: none !important; }
        
        /* Gallery */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .theme-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .theme-card:hover { border-color: var(--accent); }
        
        .theme-preview {
            display: flex;
            gap: 4px;
            margin-bottom: 0.5rem;
        }
        
        .theme-color {
            flex: 1;
            height: 40px;
            border-radius: 4px;
        }
        
        .theme-name { font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; }
        .theme-author { font-size: 0.75rem; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <span class="logo-text">Pebble Studio</span>
            </div>
            
            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-label">Design</div>
                    <button class="nav-item active" onclick="showPanel('media')">üé¨ Media</button>
                    <button class="nav-item" onclick="showPanel('colors')">üé® Colors</button>
                    <button class="nav-item" onclick="showPanel('content')">‚úèÔ∏è Content</button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-label">Community</div>
                    <button class="nav-item" onclick="showPanel('gallery')">üåê Theme Gallery</button>
                    <button class="nav-item" onclick="openSaveModal()">üíæ Save to Cloud</button>
                    <button class="nav-item" onclick="openLoadModal()">üìÇ Load Theme</button>
                </div>
            </nav>
        </aside>
        
        <main class="main">
            <div class="header">
                <h1 id="panelTitle">Media</h1>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="openShareModal()">üîó</button>
                    <a href="#" onclick="openPreview(); return false;" class="btn btn-secondary">Preview ‚Üí</a>
                </div>
            </div>
            
            <!-- Media Panel -->
            <div id="panel-media" class="panel active">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üè† Hero Background</span>
                    </div>
                    <div class="media-section-item">
                        <div class="media-preview" id="heroPreview"></div>
                        <div class="media-info">
                            <div class="media-label">Hero Section</div>
                            <div class="media-type" id="heroType">video</div>
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="openMediaPicker('hero')">Change</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìë Slide Backgrounds</span>
                    </div>
                    <div id="slideMediaList"></div>
                </div>
            </div>
            
            <!-- Colors Panel -->
            <div id="panel-colors" class="panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üé® Color Scheme</span>
                    </div>
                    <div class="form-group">
                        <textarea class="form-input" id="colorPrompt" placeholder="Describe your colors... e.g. 'ocean blues' or 'warm sunset'"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="generateColors()">Generate Colors</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Current Colors</span>
                    </div>
                    <div class="color-grid" id="colorGrid"></div>
                </div>
            </div>
            
            <!-- Content Panel -->
            <div id="panel-content" class="panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üè† Hero Section</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tagline</label>
                        <input type="text" class="form-input" id="heroTagline" onchange="updateText()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Headline</label>
                        <input type="text" class="form-input" id="heroHeadline" onchange="updateText()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subheadline</label>
                        <input type="text" class="form-input" id="heroSubheadline" onchange="updateText()">
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìë Feature Slides</span>
                    </div>
                    <div id="slideContent"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìç Footer</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tagline</label>
                        <input type="text" class="form-input" id="footerTagline" onchange="updateText()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Button Text</label>
                        <input type="text" class="form-input" id="footerCta" onchange="updateText()">
                    </div>
                </div>
            </div>
            
            <!-- Gallery Panel -->
            <div id="panel-gallery" class="panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üåê Community Themes</span>
                    </div>
                    <div class="theme-grid" id="galleryGrid"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Media Picker Modal -->
    <div class="modal-overlay" id="mediaPickerModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Select Media for <span id="pickerSlotName">Hero</span></span>
                <button class="modal-close" onclick="closeMediaPicker()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchPickerTab('upload')">üì§ Upload</button>
                    <button class="tab" onclick="switchPickerTab('video')">üé¨ Videos</button>
                    <button class="tab" onclick="switchPickerTab('image')">üñºÔ∏è Images</button>
                </div>
                
                <div id="pickerUpload">
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <div id="uploadDefault">
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">Click to upload image</div>
                        </div>
                        <div id="uploadProgress" class="hidden">
                            <div class="upload-icon">‚è≥</div>
                            <div class="upload-text">Uploading...</div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileUpload(event)">
                </div>
                
                <div id="pickerVideo" class="hidden">
                    <div class="search-box">
                        <input type="text" class="search-input" id="videoSearch" placeholder="Search videos..." onkeypress="if(event.key==='Enter')searchVideos()">
                        <button class="btn btn-primary" onclick="searchVideos()">Search</button>
                    </div>
                    <div class="results-grid" id="videoResults"></div>
                </div>
                
                <div id="pickerImage" class="hidden">
                    <div class="search-box">
                        <input type="text" class="search-input" id="imageSearch" placeholder="Search images..." onkeypress="if(event.key==='Enter')searchImages()">
                        <button class="btn btn-primary" onclick="searchImages()">Search</button>
                    </div>
                    <div class="results-grid" id="imageResults"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Modal -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üíæ Save Theme</span>
                <button class="modal-close" onclick="closeSaveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Theme Name</label>
                    <input type="text" class="form-input" id="themeName" placeholder="My Awesome Theme">
                </div>
                <div class="form-group">
                    <label class="form-label">Author</label>
                    <input type="text" class="form-input" id="themeAuthor" placeholder="Anonymous">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="themePublic">
                        <span>Share publicly in gallery</span>
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveToCloud()">Save Theme</button>
            </div>
        </div>
    </div>
    
    <!-- Load Modal -->
    <div class="modal-overlay" id="loadModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üìÇ Load Theme</span>
                <button class="modal-close" onclick="closeLoadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Theme ID or URL</label>
                    <input type="text" class="form-input" id="loadThemeId" placeholder="Enter theme ID...">
                </div>
                <button class="btn btn-primary" onclick="loadFromCloud()">Load Theme</button>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üîó Share Theme</span>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-muted);">Save your theme to get a shareable link.</p>
                <div id="shareContent">
                    <button class="btn btn-primary" onclick="saveAndShare()">Save & Generate Link</button>
                </div>
                <div id="shareResult" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Share URL</label>
                        <input type="text" class="form-input" id="shareUrl" readonly onclick="this.select()">
                    </div>
                    <button class="btn btn-secondary" onclick="copyShareUrl()">Copy Link</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://wteiewheqyrbhxjzthcg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0ZWlld2hlcXlyYmh4anp0aGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDQ3MDEsImV4cCI6MjA4MjM4MDcwMX0.-tIiLKyRzsmD4MYTahTJLXHDeeMWPPNzBAigH5UzHDA';
        const PEXELS_KEY = 'JvHx5PnVieFkLRf42pUYRhIpF5stIfaJmjvSntlDXYOzwy1nmXGhpI6S';
        
        // Default Data
        const defaultMedia = {
            hero: { url: "https://videos.pexels.com/video-files/1409899/1409899-uhd_2560_1440_25fps.mp4", type: "video" },
            slide0: { url: "https://videos.pexels.com/video-files/1918465/1918465-uhd_2560_1440_24fps.mp4", type: "video" },
            slide1: { url: "https://videos.pexels.com/video-files/2169880/2169880-uhd_2560_1440_30fps.mp4", type: "video" },
            slide2: { url: "https://videos.pexels.com/video-files/1093662/1093662-uhd_2560_1440_30fps.mp4", type: "video" },
            slide3: { url: "https://videos.pexels.com/video-files/3015510/3015510-uhd_2560_1440_24fps.mp4", type: "video" },
            slide4: { url: "https://videos.pexels.com/video-files/4763824/4763824-uhd_2560_1440_24fps.mp4", type: "video" }
        };
        
        const defaultColors = {
            accentOrange: '#e85d24', accentSage: '#7d8c6e', accentSlate: '#4a5568',
            bgCream: '#f5f3ef', bgDark: '#1a1a1a', accentTaupe: '#a39b8b'
        };
        
        const defaultText = {
            hero: { tagline: 'Future Natural', headline: 'Smooth Layers', subheadline: 'Buttery smooth scrolling with video backgrounds' },
            slides: [
                { label: 'Feature 01', title: '100% Electric', subtitle: 'Zero emissions', desc: 'Clean, silent energy.' },
                { label: 'Feature 02', title: 'Magic Hitch', subtitle: 'Self-positioning', desc: 'Effortless connection.' },
                { label: 'Feature 03', title: 'Easy Tow', subtitle: 'Dual-motor', desc: 'Unwavering confidence.' },
                { label: 'Feature 04', title: 'Remote Control', subtitle: 'Full maneuverability', desc: 'Pivot effortlessly.' },
                { label: 'Feature 05', title: 'InstaCamp', subtitle: 'One-touch setup', desc: 'Camp-ready in seconds.' }
            ],
            footer: { tagline: 'The Future is Natural', cta: 'Get Started' }
        };
        
        // State
        let media = JSON.parse(JSON.stringify(defaultMedia));
        let colors = {...defaultColors};
        let text = JSON.parse(JSON.stringify(defaultText));
        let currentThemeId = null;
        let currentPickerSlot = 'hero';
        let saveTimeout = null;
        
        // Supabase helpers
        async function supabaseGet(endpoint) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            return res.json();
        }
        
        async function supabasePost(endpoint, data) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Prefer': 'return=representation' },
                body: JSON.stringify(data)
            });
            return res.json();
        }
        
        async function supabasePatch(endpoint, data) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Prefer': 'return=representation' },
                body: JSON.stringify(data)
            });
            return res.json();
        }
        
        // Toast
        function toast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show ' + type;
            setTimeout(() => t.className = 'toast', 3000);
        }
        
        // Panels
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('panel-' + name)?.classList.add('active');
            event.target.classList.add('active');
            document.getElementById('panelTitle').textContent = name.charAt(0).toUpperCase() + name.slice(1);
        }
        
        // Media Picker
        function openMediaPicker(slot) {
            currentPickerSlot = slot;
            const name = slot === 'hero' ? 'Hero' : 'Slide ' + (parseInt(slot.replace('slide', '')) + 1);
            document.getElementById('pickerSlotName').textContent = name;
            document.getElementById('mediaPickerModal').classList.add('open');
            switchPickerTab('upload');
        }
        
        function closeMediaPicker() {
            document.getElementById('mediaPickerModal').classList.remove('open');
        }
        
        function switchPickerTab(tab) {
            document.querySelectorAll('#mediaPickerModal .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('pickerUpload').classList.toggle('hidden', tab !== 'upload');
            document.getElementById('pickerVideo').classList.toggle('hidden', tab !== 'video');
            document.getElementById('pickerImage').classList.toggle('hidden', tab !== 'image');
        }
        
        // File Upload
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('uploadDefault').classList.add('hidden');
            document.getElementById('uploadProgress').classList.remove('hidden');
            
            try {
                const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${file.type.split('/')[1] || 'jpg'}`;
                const res = await fetch(`${SUPABASE_URL}/storage/v1/object/media/${fileName}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'apikey': SUPABASE_ANON_KEY, 'Content-Type': file.type },
                    body: file
                });
                
                if (!res.ok) throw new Error('Upload failed');
                
                const url = `${SUPABASE_URL}/storage/v1/object/public/media/${fileName}`;
                media[currentPickerSlot] = { url, type: 'image' };
                save();
                renderMedia();
                closeMediaPicker();
                toast('Image uploaded!');
            } catch (err) {
                toast('Upload failed', 'error');
            }
            
            document.getElementById('uploadDefault').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }
        
        // Search Videos
        async function searchVideos() {
            const query = document.getElementById('videoSearch').value;
            if (!query) return;
            
            const res = await fetch(`https://api.pexels.com/videos/search?query=${encodeURIComponent(query)}&per_page=12`, {
                headers: { 'Authorization': PEXELS_KEY }
            });
            const data = await res.json();
            
            document.getElementById('videoResults').innerHTML = data.videos.map((v, i) => `
                <div class="result-item" onclick="selectVideo(${i})">
                    <video src="${v.video_files[0].link}" muted></video>
                </div>
            `).join('');
            
            window._videoResults = data.videos;
        }
        
        function selectVideo(i) {
            const v = window._videoResults[i];
            const file = v.video_files.find(f => f.quality === 'hd') || v.video_files[0];
            media[currentPickerSlot] = { url: file.link, type: 'video' };
            save();
            renderMedia();
            closeMediaPicker();
            toast('Video selected!');
        }
        
        // Search Images
        async function searchImages() {
            const query = document.getElementById('imageSearch').value;
            if (!query) return;
            
            const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=12`, {
                headers: { 'Authorization': PEXELS_KEY }
            });
            const data = await res.json();
            
            document.getElementById('imageResults').innerHTML = data.photos.map((p, i) => `
                <div class="result-item" onclick="selectImage(${i})">
                    <img src="${p.src.medium}" alt="">
                </div>
            `).join('');
            
            window._imageResults = data.photos;
        }
        
        function selectImage(i) {
            const p = window._imageResults[i];
            media[currentPickerSlot] = { url: p.src.large2x || p.src.large, type: 'image' };
            save();
            renderMedia();
            closeMediaPicker();
            toast('Image selected!');
        }
        
        // Render Media
        function renderMedia() {
            // Hero preview
            const hero = media.hero;
            document.getElementById('heroPreview').innerHTML = hero.type === 'video' 
                ? `<video src="${hero.url}" muted autoplay loop></video>`
                : `<img src="${hero.url}" alt="">`;
            document.getElementById('heroType').textContent = hero.type;
            
            // Slides
            document.getElementById('slideMediaList').innerHTML = [0,1,2,3,4].map(i => {
                const slot = `slide${i}`;
                const m = media[slot];
                return `
                    <div class="media-section-item">
                        <div class="media-preview">
                            ${m.type === 'video' ? `<video src="${m.url}" muted></video>` : `<img src="${m.url}" alt="">`}
                        </div>
                        <div class="media-info">
                            <div class="media-label">Slide ${i + 1}</div>
                            <div class="media-type">${m.type}</div>
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="openMediaPicker('${slot}')">Change</button>
                    </div>
                `;
            }).join('');
        }
        
        // Colors
        function renderColors() {
            const labels = { accentOrange: 'Primary', accentSage: 'Secondary', accentSlate: 'Tertiary', bgCream: 'Light BG', bgDark: 'Dark BG', accentTaupe: 'Neutral' };
            document.getElementById('colorGrid').innerHTML = Object.entries(colors).map(([key, val]) => `
                <div class="color-item">
                    <input type="color" class="color-swatch" value="${val}" onchange="updateColor('${key}', this.value)">
                    <div>
                        <div class="media-label">${labels[key]}</div>
                        <div class="color-label">${val}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateColor(key, val) {
            colors[key] = val;
            save();
            renderColors();
        }
        
        async function generateColors() {
            const prompt = document.getElementById('colorPrompt').value;
            if (!prompt) return;
            
            try {
                const res = await fetch('/api/generate-colors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();
                if (data.colors) {
                    colors = {...colors, ...data.colors};
                    save();
                    renderColors();
                    toast('Colors generated!');
                }
            } catch (e) {
                toast('Generation failed', 'error');
            }
        }
        
        // Content
        function renderContent() {
            document.getElementById('heroTagline').value = text.hero.tagline;
            document.getElementById('heroHeadline').value = text.hero.headline;
            document.getElementById('heroSubheadline').value = text.hero.subheadline;
            document.getElementById('footerTagline').value = text.footer.tagline;
            document.getElementById('footerCta').value = text.footer.cta;
            
            document.getElementById('slideContent').innerHTML = text.slides.map((s, i) => `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title">Slide ${i + 1}: ${s.title}</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" value="${s.title}" onchange="updateSlide(${i}, 'title', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" value="${s.subtitle}" onchange="updateSlide(${i}, 'subtitle', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" onchange="updateSlide(${i}, 'desc', this.value)">${s.desc}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleAccordion(el) {
            el.classList.toggle('open');
        }
        
        function updateText() {
            text.hero.tagline = document.getElementById('heroTagline').value;
            text.hero.headline = document.getElementById('heroHeadline').value;
            text.hero.subheadline = document.getElementById('heroSubheadline').value;
            text.footer.tagline = document.getElementById('footerTagline').value;
            text.footer.cta = document.getElementById('footerCta').value;
            save();
        }
        
        function updateSlide(i, field, val) {
            text.slides[i][field] = val;
            save();
        }
        
        // Save
        function save() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveNow, 1000);
        }
        
        async function saveNow() {
            try {
                if (currentThemeId) {
                    await supabasePatch(`themes?id=eq.${currentThemeId}`, { media, colors, text_content: text });
                } else {
                    const result = await supabasePost('themes', { name: 'Session', author: 'Anonymous', media, colors, text_content: text, is_public: false });
                    if (result?.[0]) {
                        currentThemeId = result[0].id;
                        document.cookie = `pebbleThemeId=${currentThemeId}; path=/; max-age=31536000`;
                    }
                }
            } catch (e) {
                console.error('Save failed:', e);
            }
        }
        
        // Gallery
        async function loadGallery() {
            const data = await supabaseGet('themes?is_public=eq.true&order=created_at.desc&limit=20');
            document.getElementById('galleryGrid').innerHTML = (data || []).map(t => `
                <div class="theme-card" onclick="loadTheme('${t.id}')">
                    <div class="theme-preview">
                        ${Object.values(t.colors || {}).slice(0, 5).map(c => `<div class="theme-color" style="background:${c}"></div>`).join('')}
                    </div>
                    <div class="theme-name">${t.name}</div>
                    <div class="theme-author">by ${t.author || 'Anonymous'}</div>
                </div>
            `).join('') || '<p style="color:var(--text-muted)">No themes yet</p>';
        }
        
        async function loadTheme(id) {
            const data = await supabaseGet(`themes?id=eq.${id}`);
            if (data?.[0]) {
                const t = data[0];
                if (t.media) media = t.media;
                if (t.colors) colors = t.colors;
                if (t.text_content) text = t.text_content;
                currentThemeId = t.id;
                // Update cookie so preview uses this theme
                document.cookie = `pebbleThemeId=${t.id}; path=/; max-age=31536000`;
                renderMedia();
                renderColors();
                renderContent();
                toast('Theme loaded!');
            }
        }
        
        // Modals
        function openSaveModal() { document.getElementById('saveModal').classList.add('open'); }
        function closeSaveModal() { document.getElementById('saveModal').classList.remove('open'); }
        function openLoadModal() { document.getElementById('loadModal').classList.add('open'); }
        function closeLoadModal() { document.getElementById('loadModal').classList.remove('open'); }
        function openShareModal() { document.getElementById('shareModal').classList.add('open'); }
        function closeShareModal() { document.getElementById('shareModal').classList.remove('open'); }
        
        async function saveToCloud() {
            const name = document.getElementById('themeName').value || 'Untitled';
            const author = document.getElementById('themeAuthor').value || 'Anonymous';
            const isPublic = document.getElementById('themePublic').checked;
            
            const result = await supabasePost('themes', { name, author, media, colors, text_content: text, is_public: isPublic });
            if (result?.[0]) {
                currentThemeId = result[0].id;
                toast('Theme saved!');
                closeSaveModal();
                if (isPublic) loadGallery();
            }
        }
        
        async function loadFromCloud() {
            let id = document.getElementById('loadThemeId').value.trim();
            if (id.includes('/')) id = id.split('/').pop();
            if (!id) return;
            
            await loadTheme(id);
            closeLoadModal();
        }
        
        async function saveAndShare() {
            const result = await supabasePost('themes', { name: 'Shared Theme', author: 'Anonymous', media, colors, text_content: text, is_public: false });
            if (result?.[0]) {
                currentThemeId = result[0].id;
                const url = `${window.location.origin}/theme/${result[0].id}`;
                document.getElementById('shareUrl').value = url;
                document.getElementById('shareContent').classList.add('hidden');
                document.getElementById('shareResult').classList.remove('hidden');
            }
        }
        
        function copyShareUrl() {
            navigator.clipboard.writeText(document.getElementById('shareUrl').value);
            toast('Link copied!');
        }
        
        // Preview
        async function openPreview() {
            if (!currentThemeId) await saveNow();
            if (currentThemeId) window.open(`/pebble-dynamic.html?theme=${currentThemeId}`, '_blank');
        }
        
        // Init
        async function init() {
            // Load existing theme from cookie
            const cookie = document.cookie.split('; ').find(c => c.startsWith('pebbleThemeId='));
            if (cookie) {
                const id = cookie.split('=')[1];
                const data = await supabaseGet(`themes?id=eq.${id}`);
                if (data?.[0]) {
                    const t = data[0];
                    if (t.media) media = t.media;
                    if (t.colors) colors = t.colors;
                    if (t.text_content) text = t.text_content;
                    currentThemeId = id;
                }
            }
            
            renderMedia();
            renderColors();
            renderContent();
            loadGallery();
        }
        
        init();
    </script>
</body>
</html>
